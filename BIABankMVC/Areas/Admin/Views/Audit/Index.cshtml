@using BankingSystemMVC.Areas.Admin.Models.ViewModels.Audit
@model List<AuditLogViewModel>
@{
    ViewData["Title"] = "Audit Logs";
    var filter = ViewBag.Filter as AuditFilterViewModel ?? new AuditFilterViewModel();
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h1><i class="bi bi-journal-text"></i> Audit Logs</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-area="Admin" asp-controller="Dashboard" asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item active">Audit Logs</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-3">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> Filter Audit Logs</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-2">
                    <label for="actionFilter" class="form-label">Action</label>
                    <select class="form-select" id="actionFilter">
                        <option value="">All Actions</option>
                        @for (int i = 1; i <= 22; i++)
                        {
                            var actionName = i switch
                            {
                                1 => "User Registration",
                                2 => "User Login",
                                3 => "User Logout",
                                4 => "Account Created",
                                5 => "Account Frozen",
                                6 => "Account Unfrozen",
                                7 => "Password Changed",
                                8 => "Profile Updated",
                                9 => "Admin Login",
                                10 => "Admin Logout",
                                11 => "Admin Action",
                                12 => "Suspicious Activity",
                                13 => "Transaction Initiated",
                                14 => "Transaction Completed",
                                15 => "Transaction Failed",
                                16 => "KYC Submitted",
                                17 => "KYC Approved",
                                18 => "KYC Rejected",
                                19 => "KYC Document Uploaded",
                                20 => "Report Created",
                                21 => "Report Status Updated",
                                22 => "Customer Deleted",
                                _ => "Unknown"
                            };
                            var isSelected = filter.ActionFilter == i;
                            <option value="@i" selected="@isSelected">@actionName (@i)</option>
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="entityFilter" class="form-label">Entity Type</label>
                    <select class="form-select" id="entityFilter">
                        <option value="">All Entities</option>
                        @{
                            var entities = new[] { "User", "Customer", "Account", "Transaction", "KYCDocument", "AdminUser" };
                            foreach (var entity in entities)
                            {
                                var isSelected = filter.EntityFilter == entity;
                                <option value="@entity" selected="@isSelected">@entity</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="searchRef" class="form-label">Search</label>
                    <input type="text" id="searchRef" class="form-control" placeholder="Search description..." value="@filter.SearchRef">
                </div>
                <div class="col-md-1">
                    <label for="customerIdFilter" class="form-label">User ID</label>
                    <input type="text" class="form-control" id="customerIdFilter" placeholder="ID" value="@filter.CustomerIdFilter">
                </div>
                <div class="col-md-2">
                    <label for="fromDate" class="form-label">From Date</label>
                    <input type="date" id="fromDate" class="form-control" value="@(filter.FromDate?.ToString("yyyy-MM-dd"))">
                </div>
                <div class="col-md-2">
                    <label for="toDate" class="form-label">To Date</label>
                    <input type="date" id="toDate" class="form-control" value="@(filter.ToDate?.ToString("yyyy-MM-dd"))">
                </div>
                <div class="col-md-1 d-flex align-items-end gap-2">
                    <button type="button" class="btn btn-primary" onclick="AdminAuditFilters.applyFilters()">
                        <i class="bi bi-search"></i>
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="AdminAuditFilters.clearFilters()">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Logs Table -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-list"></i> System Audit Logs</h5>
            <div>
                <span class="badge bg-secondary me-2" id="logCount">@(Model?.Count ?? 0) records</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="AdminAuditFilters.refreshLogs()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="AdminAuditFilters.exportLogs()">
                    <i class="bi bi-download"></i> Export
                </button>
            </div>
        </div>
        <div class="card-body p-0" id="auditLogsContainer">
            @await Html.PartialAsync("_AuditLogsTable", Model)
        </div>
    </div>
</div>

<!-- Audit Log Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logDetailsModalLabel">
                    <i class="bi bi-info-circle"></i> Audit Log Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-info"></i> Basic Information</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Log ID:</strong></td>
                                        <td id="modal-id"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Action:</strong></td>
                                        <td id="modal-action"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Entity:</strong></td>
                                        <td id="modal-entity"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Customer ID:</strong></td>
                                        <td id="modal-customerid"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Date:</strong></td>
                                        <td id="modal-date"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-hdd-network"></i> Technical Details</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>IP Address:</strong></td>
                                        <td id="modal-ip"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>User Agent:</strong></td>
                                        <td id="modal-useragent" style="word-break: break-all;"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-file-text"></i> Description</h6>
                            </div>
                            <div class="card-body">
                                <p id="modal-description" class="mb-0"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3" id="metadata-section" style="display: none;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="bi bi-code"></i> Metadata</h6>
                            </div>
                            <div class="card-body">
                                <pre id="modal-metadata" class="bg-light p-3 rounded" style="font-size: 0.85rem;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x"></i> Close
                </button>
                <button type="button" class="btn btn-primary" onclick="copyLogDetails()">
                    <i class="bi bi-clipboard"></i> Copy Details
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .table td {
        vertical-align: middle;
        font-size: 0.9rem;
    }
    
    .badge {
        font-size: 0.75rem;
    }
    
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .form-select, .form-control {
        font-size: 0.9rem;
    }
    
    .btn {
        font-size: 0.9rem;
    }
    
    .modal-body .card {
        border: 1px solid #dee2e6;
        margin-bottom: 0;
    }
    
    .modal-body .table td {
        padding: 0.5rem;
        border-top: 1px solid #dee2e6;
    }
    
    .modal-body .table td:first-child {
        width: 30%;
        background-color: #f8f9fa;
    }
    
    #modal-metadata {
        max-height: 200px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
    }
</style>

@section Scripts {
    <script src="~/js/admin-audit-filters.min.js"></script>
    <script>
        $(document).ready(function() {
            AdminAuditFilters.init('@Url.Action("Index", "Audit", new { area = "Admin" })');
        });

        function showLogDetails(button, logId) {
            if (!button) return;
            
            try {
                const logData = {
                    Id: button.getAttribute('data-log-id'),
                    ActionNumber: button.getAttribute('data-action'),
                    Entity: button.getAttribute('data-entity'),
                    CustomerId: button.getAttribute('data-customerid'),
                    Description: button.getAttribute('data-description'),
                    Date: button.getAttribute('data-date'),
                    IpAddress: button.getAttribute('data-ip'),
                    UserAgent: button.getAttribute('data-useragent'),
                    Metadata: button.getAttribute('data-metadata')
                };
                
                document.getElementById('modal-id').textContent = logData.Id || 'N/A';
                document.getElementById('modal-action').innerHTML = `<span class="badge bg-primary">${logData.ActionNumber}</span>`;
                document.getElementById('modal-entity').textContent = logData.Entity || 'N/A';
                document.getElementById('modal-customerid').innerHTML = `<span class="badge bg-info">${logData.CustomerId}</span>`;
                document.getElementById('modal-date').textContent = logData.Date || 'N/A';
                document.getElementById('modal-ip').textContent = logData.IpAddress || 'N/A';
                document.getElementById('modal-useragent').textContent = logData.UserAgent || 'N/A';
                document.getElementById('modal-description').textContent = logData.Description || 'N/A';
                
                const metadataSection = document.getElementById('metadata-section');
                const metadataElement = document.getElementById('modal-metadata');
                
                if (logData.Metadata && logData.Metadata.trim() !== '') {
                    metadataSection.style.display = 'block';
                    try {
                        const parsedMetadata = JSON.parse(logData.Metadata);
                        metadataElement.textContent = JSON.stringify(parsedMetadata, null, 2);
                    } catch {
                        metadataElement.textContent = logData.Metadata;
                    }
                } else {
                    metadataSection.style.display = 'none';
                }
                
                const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
                modal.show();
            } catch (error) {
                console.error('Error displaying log details:', error);
            }
        }
        
        function copyLogDetails() {
            const details = {
                id: document.getElementById('modal-id').textContent,
                action: document.getElementById('modal-action').textContent,
                entity: document.getElementById('modal-entity').textContent,
                customerId: document.getElementById('modal-customerid').textContent,
                date: document.getElementById('modal-date').textContent,
                ipAddress: document.getElementById('modal-ip').textContent,
                userAgent: document.getElementById('modal-useragent').textContent,
                description: document.getElementById('modal-description').textContent,
                metadata: document.getElementById('modal-metadata').textContent
            };
            
            const detailsText = Object.entries(details)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n');
                
            navigator.clipboard.writeText(detailsText).then(() => {
                alert('Log details copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy to clipboard');
            });
        }
    </script>
}