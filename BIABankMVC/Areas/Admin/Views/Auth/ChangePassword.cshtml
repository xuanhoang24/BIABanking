@model BankingSystemMVC.Areas.Admin.Models.ViewModels.Auth.ChangePasswordViewModel
@{
    ViewData["Title"] = "Change Password";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card shadow">
            <div class="card-body p-5">
                <div class="text-center mb-4">
                    <i class="fas fa-key fa-3x text-warning mb-3"></i>
                    <h2>Change Password</h2>
                    @if (Model.IsFirstLogin)
                    {
                        <div class="alert alert-warning mt-3" role="alert">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>First Time Login:</strong> You must change your default password before continuing.
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Update your password to keep your account secure</p>
                    }
                </div>

                <partial name="_ErrorAlert" model="null" />

                <form asp-area="Admin" asp-controller="Auth" asp-action="ChangePassword" method="post">
                    <input type="hidden" asp-for="IsFirstLogin" />

                    <div class="mb-3">
                        <label asp-for="CurrentPassword" class="form-label">
                            <i class="fas fa-lock"></i> Current Password
                        </label>
                        <input asp-for="CurrentPassword" class="form-control" placeholder="Enter current password" />
                        <span asp-validation-for="CurrentPassword" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="NewPassword" class="form-label">
                            <i class="fas fa-key"></i> New Password
                        </label>
                        <input asp-for="NewPassword" id="newPassword" class="form-control" placeholder="Enter new password" />
                        <small class="form-text text-muted">
                            Must be at least 6 characters with 1 capital letter and 1 special character
                        </small>
                        <div id="passwordRequirements" class="mt-2" style="display: none;">
                            <small class="d-block text-danger" id="lengthCheck">
                                <i class="bi bi-x-circle"></i> At least 6 characters
                            </small>
                            <small class="d-block text-danger" id="capitalCheck">
                                <i class="bi bi-x-circle"></i> At least 1 capital letter
                            </small>
                            <small class="d-block text-danger" id="specialCheck">
                                <i class="bi bi-x-circle"></i> At least 1 special character
                            </small>
                        </div>
                        <span asp-validation-for="NewPassword" class="text-danger"></span>
                    </div>

                    <div class="mb-4">
                        <label asp-for="ConfirmPassword" class="form-label">
                            <i class="fas fa-check-circle"></i> Confirm New Password
                        </label>
                        <input asp-for="ConfirmPassword" id="confirmPassword" class="form-control" placeholder="Re-enter new password" />
                        <small id="confirmPasswordFeedback" class="form-text"></small>
                        <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg w-100">
                        <i class="fas fa-save"></i> Change Password
                    </button>
                </form>

                @if (!Model.IsFirstLogin)
                {
                    <div class="text-center mt-3">
                        <a asp-area="Admin" asp-controller="Dashboard" asp-action="Index" class="text-muted">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<style>
    .card {
        border: none;
        border-radius: 15px;
    }

    .card-body {
        border-radius: 15px;
    }

    .form-control {
        border-radius: 10px;
        padding: 12px 15px;
    }

    .btn-lg {
        border-radius: 10px;
        padding: 12px 20px;
    }
</style>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        $(document).ready(function() {
            // Get form elements
            var newPwd = $('#' + 'newPassword');
            var confirmPwd = $('#' + 'confirmPassword');
            var requirements = $('#' + 'passwordRequirements');

            // Update validation check display (icon and color)
            function updateCheck(element, isValid, text) {
                var icon = isValid ? 'bi-check-circle' : 'bi-x-circle';
                var color = isValid ? 'text-success' : 'text-danger';
                element.html('<i class="bi ' + icon + '"></i> ' + text)
                    .removeClass('text-success text-danger')
                    .addClass(color);
            }

            // Validate password requirements on input
            newPwd.on('input', function() {
                var pwd = $(this).val();
                
                if (pwd.length > 0) {
                    requirements.show();
                    // Check each requirement
                    updateCheck($('#' + 'lengthCheck'), pwd.length >= 6, 'At least 6 characters');
                    updateCheck($('#' + 'capitalCheck'), /[A-Z]/.test(pwd), 'At least 1 capital letter');
                    updateCheck($('#' + 'specialCheck'), /[!@@#$%^&*(),.?"':{}|<>]/.test(pwd), 'At least 1 special character');
                } else {
                    requirements.hide();
                }
                
                checkMatch();
            });

            // Check password match on confirm input
            confirmPwd.on('input', checkMatch);

            // Verify passwords match
            function checkMatch() {
                var pwd = newPwd.val();
                var confirm = confirmPwd.val();
                var feedback = $('#' + 'confirmPasswordFeedback');
                
                if (confirm.length > 0) {
                    updateCheck(feedback, pwd === confirm, pwd === confirm ? 'Passwords match' : 'Passwords do not match');
                } else {
                    feedback.html('');
                }
            }
        });
    </script>
}
