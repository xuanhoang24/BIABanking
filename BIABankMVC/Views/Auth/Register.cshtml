@using BankingSystemMVC.Models.ViewModels.Auth
@model RegisterViewModel

<div class="form-page">
    <h2>Create Account</h2>

    <partial name="_ErrorAlert" model="null" />

    <form asp-action="Register" method="post">
        <div class="form-group">
            <label asp-for="FirstName" class="form-label">First Name</label>
            <input asp-for="FirstName" class="form-control" />
            <span asp-validation-for="FirstName" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="LastName" class="form-label">Last Name</label>
            <input asp-for="LastName" class="form-control" />
            <span asp-validation-for="LastName" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Email" class="form-label">Email</label>
            <input asp-for="Email" class="form-control" />
            <span asp-validation-for="Email" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Password" class="form-label">Password</label>
            <input asp-for="Password" id="password" type="password" class="form-control" minlength="6" />
            <small class="form-text text-muted">At least 6 characters, 1 capital letter, and 1 special character</small>
            <div id="passwordRequirements" class="mt-2" style="display: none;">
                <small class="d-block text-danger" id="lengthCheck">
                    <i class="bi bi-x-circle"></i> At least 6 characters
                </small>
                <small class="d-block text-danger" id="capitalCheck">
                    <i class="bi bi-x-circle"></i> At least 1 capital letter
                </small>
                <small class="d-block text-danger" id="specialCheck">
                    <i class="bi bi-x-circle"></i> At least 1 special character
                </small>
            </div>
            <span asp-validation-for="Password" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="ConfirmPassword" class="form-label">Confirm Password</label>
            <input asp-for="ConfirmPassword" id="confirmPassword" type="password" class="form-control" />
            <small id="confirmPasswordFeedback" class="form-text"></small>
            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="PhoneNumber" class="form-label">Phone Number</label>
            <input asp-for="PhoneNumber" class="form-control" type="tel" pattern="\d{10}" maxlength="10" placeholder="1234567890" />
            <small class="form-text text-muted">Enter 10 digits without spaces or dashes</small>
            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="DateOfBirth" class="form-label">Date of Birth</label>
            <input asp-for="DateOfBirth" type="date" class="form-control" id="dateOfBirth" />
            <small class="form-text text-muted">Must be between 01/01/1900 and @DateTime.Today.AddYears(-16).ToString("MM/dd/yyyy") (at least 16 years old)</small>
            <span asp-validation-for="DateOfBirth" class="text-danger"></span>
        </div>

        <div class="form-group">
            <label asp-for="Address" class="form-label">Address</label>
            <input asp-for="Address" class="form-control" />
            <span asp-validation-for="Address" class="text-danger"></span>
        </div>

        <button type="submit" class="btn btn-primary">Create Account</button>
    </form>

    <div class="text-center mt-4">
        <p class="text-muted">Already have an account? <a asp-action="Login">Sign In</a></p>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        $(document).ready(function() {
            // Get form elements
            var pwd = $('#' + 'password');
            var confirmPwd = $('#' + 'confirmPassword');
            var requirements = $('#' + 'passwordRequirements');

            // Update validation check display (icon and color)
            function updateCheck(element, isValid, text) {
                var icon = isValid ? 'bi-check-circle' : 'bi-x-circle';
                var color = isValid ? 'text-success' : 'text-danger';
                element.html('<i class="bi ' + icon + '"></i> ' + text)
                    .removeClass('text-success text-danger')
                    .addClass(color);
            }

            // Validate password requirements on input
            pwd.on('input', function() {
                var password = $(this).val();
                
                if (password.length > 0) {
                    requirements.show();
                    // Check each requirement
                    updateCheck($('#' + 'lengthCheck'), password.length >= 6, 'At least 6 characters');
                    updateCheck($('#' + 'capitalCheck'), /[A-Z]/.test(password), 'At least 1 capital letter');
                    updateCheck($('#' + 'specialCheck'), /[!@@#$%^&*(),.?"':{}|<>]/.test(password), 'At least 1 special character');
                } else {
                    requirements.hide();
                }
                
                checkMatch();
            });

            // Check password match on confirm input
            confirmPwd.on('input', checkMatch);

            // Verify passwords match
            function checkMatch() {
                var password = pwd.val();
                var confirm = confirmPwd.val();
                var feedback = $('#' + 'confirmPasswordFeedback');
                
                if (confirm.length > 0) {
                    updateCheck(feedback, password === confirm, password === confirm ? 'Passwords match' : 'Passwords do not match');
                } else {
                    feedback.html('');
                }
            }

            // Calculate age from birth date
            function calculateAge(birthDate) {
                var today = new Date();
                var age = today.getFullYear() - birthDate.getFullYear();
                var m = today.getMonth() - birthDate.getMonth();
                // Adjust age if birthday hasn't occurred this year yet
                if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            }
            
            // Validate date of birth on change or blur
            $('#dateOfBirth').on('change blur', function() {
                var dateValue = $(this).val();
                if (!dateValue) return;
                
                var date = new Date(dateValue);
                var $error = $(this).siblings('.text-danger');
                
                // Check if year is before 1900
                if (date.getFullYear() < 1900) {
                    $error.text('Please enter a valid date of birth');
                    $(this).addClass('input-validation-error');
                }
                // Check if date is in the future
                else if (date > new Date()) {
                    $error.text('Date of birth cannot be in the future');
                    $(this).addClass('input-validation-error');
                }
                // Check if user is at least 16 years old
                else if (calculateAge(date) < 16) {
                    $error.text('You must be at least 16 years old to register');
                    $(this).addClass('input-validation-error');
                }
                // Clear error if valid
                else {
                    $error.text('');
                    $(this).removeClass('input-validation-error');
                }
            });
        });
    </script>
}
