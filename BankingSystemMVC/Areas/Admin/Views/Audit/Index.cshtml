@model List<BankingSystemMVC.Areas.Admin.Models.AuditLogViewModel>
@{
    ViewData["Title"] = "Audit Logs";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Audit Logs</h1>
                <div>
                    <button class="btn btn-outline-secondary" onclick="refreshLogs()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="btn btn-outline-primary" onclick="exportLogs()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter"></i> Filters
                        <button class="btn btn-sm btn-outline-secondary float-end" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse" id="filterCollapse">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <label class="form-label">Action</label>
                                <select class="form-select" id="actionFilter">
                                    <option value="">All Actions</option>
                                    <option value="1">User Registration (1)</option>
                                    <option value="2">User Login (2)</option>
                                    <option value="3">User Logout (3)</option>
                                    <option value="4">Account Created (4)</option>
                                    <option value="5">Account Frozen (5)</option>
                                    <option value="6">Account Unfrozen (6)</option>
                                    <option value="7">Password Changed (7)</option>
                                    <option value="8">Profile Updated (8)</option>
                                    <option value="9">Admin Login (9)</option>
                                    <option value="10">Admin Logout (10)</option>
                                    <option value="11">Admin Action (11)</option>
                                    <option value="12">Suspicious Activity (12)</option>
                                    <option value="13">Transaction Initiated (13)</option>
                                    <option value="14">Transaction Completed (14)</option>
                                    <option value="15">Transaction Failed (15)</option>
                                    <option value="16">KYC Submitted (16)</option>
                                    <option value="17">KYC Approved (17)</option>
                                    <option value="18">KYC Rejected (18)</option>
                                    <option value="19">KYC Document Uploaded (19)</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Entity Type</label>
                                <select class="form-select" id="entityFilter">
                                    <option value="">All Entities</option>
                                    <option value="User">User</option>
                                    <option value="Account">Account</option>
                                    <option value="Transaction">Transaction</option>
                                    <option value="KYCDocument">KYC Document</option>
                                    <option value="AdminUser">Admin User</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Customer ID</label>
                                <input type="text" class="form-control" id="customerIdFilter" placeholder="Enter Customer ID">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Date Range</label>
                                <input type="date" class="form-control" id="dateFilter">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button class="btn btn-primary" onclick="applyFilters()">
                                    <i class="fas fa-search"></i> Apply Filters
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Audit Logs Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> System Audit Logs
                        <span class="badge bg-secondary ms-2" id="logCount">@(Model?.Count ?? 0) records</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    @if (Model != null && Model.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0" id="auditTable">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 80px;">
                                            <i class="fas fa-hashtag"></i> Action
                                        </th>
                                        <th style="width: 150px;">
                                            <i class="fas fa-cube"></i> Entity
                                        </th>
                                        <th style="width: 100px;">
                                            <i class="fas fa-user"></i> User ID
                                        </th>
                                        <th>
                                            <i class="fas fa-info-circle"></i> Description
                                        </th>
                                        <th style="width: 180px;">
                                            <i class="fas fa-clock"></i> Date
                                        </th>
                                        <th style="width: 100px;">
                                            <i class="fas fa-cog"></i> Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var log in Model)
                                    {
                                        <tr>
                                            <td>
                                                <span class="badge bg-primary fs-6">
                                                    @log.ActionNumber
                                                </span>
                                            </td>
                                            <td>
                                                <small class="text-muted fw-bold">
                                                    @log.Entity
                                                </small>
                                            </td>
                                            <td>
                                                <span class="badge bg-info">
                                                    @log.CustomerId
                                                </span>
                                            </td>
                                            <td>
                                                <span class="text-dark">@log.Description</span>
                                            </td>
                                            <td>
                                                <small class="text-muted">
                                                    <i class="fas fa-calendar-alt"></i>
                                                    @log.Date
                                                </small>
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-info" 
                                                        onclick="showLogDetails(this, @log.Id)"
                                                        data-log-id="@log.Id"
                                                        data-action="@log.ActionNumber"
                                                        data-entity="@Html.Encode(log.Entity)"
                                                        data-customerid="@log.CustomerId"
                                                        data-description="@Html.Encode(log.Description)"
                                                        data-date="@log.Date"
                                                        data-ip="@Html.Encode(log.IpAddress ?? "N/A")"
                                                        data-useragent="@Html.Encode(log.UserAgent ?? "N/A")"
                                                        data-metadata="@Html.Encode(log.Metadata ?? "")"
                                                        title="View Details">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">No Audit Logs Found</h4>
                            <p class="text-muted">No audit logs match your current filters or none exist yet.</p>
                            <button class="btn btn-outline-primary" onclick="clearFilters()">
                                <i class="fas fa-refresh"></i> Clear Filters
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    @if (Model != null && Model.Any())
    {
        <div class="row mt-4">
            <div class="col-12">
                <nav aria-label="Audit logs pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" tabindex="-1">
                                <i class="fas fa-chevron-left"></i> Previous
                            </a>
                        </li>
                        <li class="page-item active">
                            <a class="page-link" href="#">1</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">2</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">3</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="#">
                                Next <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    }
</div>

<!-- Audit Log Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1" aria-labelledby="logDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logDetailsModalLabel">
                    <i class="fas fa-info-circle"></i> Audit Log Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-info"></i> Basic Information</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Log ID:</strong></td>
                                        <td id="modal-id"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Action:</strong></td>
                                        <td id="modal-action"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Entity:</strong></td>
                                        <td id="modal-entity"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Customer ID:</strong></td>
                                        <td id="modal-customerid"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Date:</strong></td>
                                        <td id="modal-date"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-network-wired"></i> Technical Details</h6>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>IP Address:</strong></td>
                                        <td id="modal-ip"></td>
                                    </tr>
                                    <tr>
                                        <td><strong>User Agent:</strong></td>
                                        <td id="modal-useragent" style="word-break: break-all;"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-file-alt"></i> Description</h6>
                            </div>
                            <div class="card-body">
                                <p id="modal-description" class="mb-0"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mt-3" id="metadata-section" style="display: none;">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-code"></i> Metadata</h6>
                            </div>
                            <div class="card-body">
                                <pre id="modal-metadata" class="bg-light p-3 rounded" style="font-size: 0.85rem;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Close
                </button>
                <button type="button" class="btn btn-primary" onclick="copyLogDetails()">
                    <i class="fas fa-copy"></i> Copy Details
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .table th {
        border-top: none;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .table td {
        vertical-align: middle;
        font-size: 0.9rem;
    }
    
    .badge {
        font-size: 0.75rem;
    }
    
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .form-select, .form-control {
        font-size: 0.9rem;
    }
    
    .btn {
        font-size: 0.9rem;
    }
    
    .modal-body .card {
        border: 1px solid #dee2e6;
        margin-bottom: 0;
    }
    
    .modal-body .table td {
        padding: 0.5rem;
        border-top: 1px solid #dee2e6;
    }
    
    .modal-body .table td:first-child {
        width: 30%;
        background-color: #f8f9fa;
    }
    
    #modal-metadata {
        max-height: 200px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
    }
</style>

<script>
    function refreshLogs() {
        location.reload();
    }
    
    function exportLogs() {
        // TODO: Implement export functionality
        alert('Export functionality will be implemented soon');
    }
    
    function applyFilters() {
        // TODO: Implement filtering functionality
        const action = document.getElementById('actionFilter').value;
        const entity = document.getElementById('entityFilter').value;
        const customerId = document.getElementById('customerIdFilter').value;
        const date = document.getElementById('dateFilter').value;
        
        console.log('Applying filters:', { action, entity, customerId, date });
        alert('Filter functionality will be implemented soon');
    }
    
    function clearFilters() {
        document.getElementById('actionFilter').value = '';
        document.getElementById('entityFilter').value = '';
        document.getElementById('customerIdFilter').value = '';
        document.getElementById('dateFilter').value = '';
    }
    
    // Show log details in modal
    function showLogDetails(button, logId) {
        console.log('showLogDetails called with logId:', logId);
        console.log('Button:', button);
        
        if (!button) {
            console.error('Button not found');
            alert('Error: Button not found');
            return;
        }
        
        try {
            // Get data from button attributes
            const logData = {
                Id: button.getAttribute('data-log-id'),
                ActionNumber: button.getAttribute('data-action'),
                Entity: button.getAttribute('data-entity'),
                CustomerId: button.getAttribute('data-customerid'),
                Description: button.getAttribute('data-description'),
                Date: button.getAttribute('data-date'),
                IpAddress: button.getAttribute('data-ip'),
                UserAgent: button.getAttribute('data-useragent'),
                Metadata: button.getAttribute('data-metadata')
            };
            
            // Populate basic information
            document.getElementById('modal-id').textContent = logData.Id || 'N/A';
            document.getElementById('modal-action').innerHTML = `<span class="badge bg-primary">${logData.ActionNumber}</span>`;
            document.getElementById('modal-entity').textContent = logData.Entity || 'N/A';
            document.getElementById('modal-customerid').innerHTML = `<span class="badge bg-info">${logData.CustomerId}</span>`;
            document.getElementById('modal-date').textContent = logData.Date || 'N/A';
            
            // Populate technical details
            document.getElementById('modal-ip').textContent = logData.IpAddress || 'N/A';
            document.getElementById('modal-useragent').textContent = logData.UserAgent || 'N/A';
            
            // Populate description
            document.getElementById('modal-description').textContent = logData.Description || 'N/A';
            
            // Handle metadata
            const metadataSection = document.getElementById('metadata-section');
            const metadataElement = document.getElementById('modal-metadata');
            
            if (logData.Metadata && logData.Metadata.trim() !== '') {
                metadataSection.style.display = 'block';
                try {
                    // Try to format as JSON if possible
                    const parsedMetadata = JSON.parse(logData.Metadata);
                    metadataElement.textContent = JSON.stringify(parsedMetadata, null, 2);
                } catch {
                    // If not JSON, display as plain text
                    metadataElement.textContent = logData.Metadata;
                }
            } else {
                metadataSection.style.display = 'none';
            }
            
            // Show the modal
            const modalElement = document.getElementById('logDetailsModal');
            console.log('Modal element:', modalElement);
            
            if (typeof bootstrap !== 'undefined') {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                console.log('Modal shown');
            } else {
                console.error('Bootstrap not found');
                alert('Bootstrap not loaded');
            }
            
        } catch (error) {
            console.error('Error displaying log details:', error);
            alert('Error displaying log details: ' + error.message);
        }
    }
    
    // Copy log details to clipboard
    function copyLogDetails() {
        const details = {
            id: document.getElementById('modal-id').textContent,
            action: document.getElementById('modal-action').textContent,
            entity: document.getElementById('modal-entity').textContent,
            customerId: document.getElementById('modal-customerid').textContent,
            date: document.getElementById('modal-date').textContent,
            ipAddress: document.getElementById('modal-ip').textContent,
            userAgent: document.getElementById('modal-useragent').textContent,
            description: document.getElementById('modal-description').textContent,
            metadata: document.getElementById('modal-metadata').textContent
        };
        
        const detailsText = Object.entries(details)
            .map(([key, value]) => `${key}: ${value}`)
            .join('\n');
            
        navigator.clipboard.writeText(detailsText).then(() => {
            alert('Log details copied to clipboard!');
        }).catch(() => {
            alert('Failed to copy to clipboard');
        });
    }

    // Auto-refresh every 30 seconds
    setInterval(function() {
        const refreshBtn = document.querySelector('[onclick="refreshLogs()"]');
        if (refreshBtn) {
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Refreshing...';
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
    }, 30000);
</script>